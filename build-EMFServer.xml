<?xml version="1.0"?> 
<project name="EMF" default="all" basedir="."> 

<!-- utilize predefined environment variables -->
<property name="env" environment="env" value="env"/>
<property name="J2EE_HOME" value="${env.J2EE_HOME}"/>
<property name="JAVA_HOME" value="${env.JAVA_HOME}"/>
<property name="src" value="."/> 
<property name="build" value="build"/>

<!-- Create the class path -->
<path id="common.class.path">
  <pathelement location="."/>
  <pathelement location="${J2EE_HOME}/lib/j2ee.jar"/> 
  <pathelement location="${J2EE_HOME}/lib/j2ee-svc.jar"/> 	
</path>

<!-- create a reference for the class path utilized -->
<property name="common.class.path" refid="common.class.path" />

	<!-- set up basic variables that are needed to execute the build -->
	<target name="init" depends="common">
	  <property name="app.name" value="emf" />
	  <property name="ear.name" value="${app.name}" />
	  <property name="web.name" value="${ear.name}" />
	  <property name="bld.dir" value="./build" />
	  <property name="etc.dir" value="./etc" />
	  <property name="misc.dir" value="./misc" />	
	  <property name="lib.dir" value="./lib" />
	  <property name="dist.dir" value="./dist" />
	  <property name="src.ejb.dir" value="./ejb" />
	  <property name="src.web.dir" value="./src" />
	  <property name="bin.web.dir" value="./bin" />	
	  <property name="src.html.dir" value="./public_html" />
	  <property name="bld.ear.dir" value="${bld.dir}/${ear.name}" />
	  <property name="bld.web.dir" value="${bld.ear.dir}/${web.name}" />
	  <property name="bld.compiler" value="classic" />
	  <property name="class.files" value="**/*.class" />
	  <property name="bak.files" value="**/*~,**/*.bak" />
	</target>

<target name="all" depends="j2ee-ear" />

<target name="common">
  <echo message="BuildName: ${ant.project.name}" />
  <echo message="BuildHome: ${basedir}" />
  <echo message="SourceHome: ${basedir}\src" /> 
  <echo message="BuildFile: ${ant.file}" />
  <echo message="BuildJVM: ${ant.java.version}" />
</target>

<!-- Make sure the basic directories are in place for the build -->
<target name="setup" depends="init">
  <mkdir dir="${lib.dir}" />
  <mkdir dir="${bld.dir}" />
  <mkdir dir="${etc.dir}" /> 
  <mkdir dir="${bld.ear.dir}" />
  <mkdir dir="${bld.ear.dir}/META-INF" />
  <mkdir dir="${bld.web.dir}/WEB-INF/classes" />
  <mkdir dir="${bld.web.dir}/WEB-INF/attachments" />
  <mkdir dir="${bld.web.dir}/WEB-INF/lib" />	
  <mkdir dir="${basedir}/classes" /> 
  <mkdir dir="${dist.dir}/lib"/>
  
</target>

<!-- Clean up everthing -->
<target name="clean" depends="init">
  <delete dir="${bld.dir}" />
  <delete dir="${lib.dir}" />
  <delete dir="${dist.dir}"/>
  <delete dir="${src.web.dir}/doc" /> 
  <delete dir="${basedir}/classes" /> 
  <delete>
    <fileset dir="." includes="${bak.files}" defaultexcludes="no"/>
  </delete>
</target>

<target name="compile" depends="init"> 
      <!-- Compile the java code -->
      <javac srcdir="${src}" destdir="${build}"/> 
</target>

<target name="web-classes" depends="setup">

	<copy todir="${bld.web.dir}/WEB-INF/classes">
	    <fileset dir="${bin.web.dir}" includes="**" />
	  </copy>
	
	<copy todir="${bld.web.dir}/WEB-INF/lib">
	  <fileset dir="${lib.dir}" includes="**" />
	</copy>
	
  <!-- this makes sure that the latest code is in both classes dirs -->
  <copy todir="${basedir}\classes">
    <fileset dir="${bld.web.dir}/WEB-INF/classes" includes="**" />
  </copy>
</target>

<!-- Copies all of the .jsp and .htm* files for the web application -->
<target name="web-jsp" depends="setup">
  <copy todir="${bld.web.dir}">
    <fileset dir="${basedir}\web\jsp" includes="index.html, *.jsp, *.htm*" />
  </copy>
</target>
	
<!-- Copies descriptor files for the deployment (.war) -->
<target name="web-descriptor" depends="setup">
  <copy todir="${bld.web.dir}/WEB-INF">
    <fileset dir="${etc.dir}" includes="web.xml,*.tld,*.wsdd"/>
    <fileset dir="${basedir}\web\WEB-INF" includes="web.xml,*.tld,*.wsdd"/>
  </copy>
</target>

<!-- Creates the war file for the application -->
<target name="web-war" depends="web-classes,web-jsp,web-descriptor">
  <jar jarfile="${dist.dir}/lib/${web.name}.war">
    <fileset dir="${bld.web.dir}" includes="**" />
  </jar>
</target>

<!-- Copies descriptor files for the enterprise deployment (.ear) -->
<target name="j2ee-descriptor" depends="setup">
  <copy todir="${bld.ear.dir}/META-INF">
    <fileset dir="${etc.dir}" includes="application.xml"/>
  </copy>
</target>

<!-- Creates the .ear file for deployment on the j2ee server -->
<target name="j2ee-ear" depends="web-war,j2ee-descriptor">
  <jar jarfile="${dist.dir}/lib/${ear.name}.ear">
    <fileset dir="${dist.dir}/lib/" includes="${web.name}.war" />
    <fileset dir="${bld.ear.dir}" includes="META-INF/*.xml" />
  </jar>
  <echo message="FINISHED:use ${lib.dir}/${ear.name}.ear with deployment tool.." />
</target>

</project>
